<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°äººçš„å¯»çˆ±ä¹‹æ—…</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 500px;
            border: 2px solid #333;
            background-color: white;
            overflow: hidden;
        }

        #stick-man {
            position: absolute;
            width: 30px;
            height: 50px;
            left: 50px;
            bottom: 50px;
            z-index: 10;
        }

        #heart {
            position: absolute;
            width: 40px;
            height: 40px;
            z-index: 5;
            transition: transform 0.3s;
        }

        #heart:hover {
            transform: scale(1.2);
        }

        .line {
            position: absolute;
            background-color: black;
            transform-origin: 0 0;
            z-index: 2;
        }

        #narration {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 80%;
            text-align: center;
            font-size: 18px;
            min-height: 60px;
        }

        #proposal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 100;
        }

        #proposal h1 {
            color: #e74c3c;
            margin-bottom: 20px;
        }

        #yes-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }

        #yes-btn:hover {
            background-color: #c0392b;
        }

        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            animation: firework 1s ease-out;
        }

        @keyframes firework {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)); opacity: 0; }
        }

        .obstacle {
            position: absolute;
            background-color: #333;
            z-index: 3;
        }

        .cloud {
            position: absolute;
            background-color: #ddd;
            border-radius: 50%;
            z-index: 1;
        }
    </style>
</head>
<body>
<h1>å°äººçš„å¯»çˆ±ä¹‹æ—…</h1>
<div id="game-container">
    <div id="stick-man">ğŸ‘¨</div>
    <div id="heart">â¤ï¸</div>
    <div id="proposal">
        <h1>Will you marry me?</h1>
        <button id="yes-btn">Yes!</button>
    </div>
</div>
<div id="narration">é‚£å¤©ï¼Œæˆ‘ç©ºç™½çš„ä¸–ç•Œé‡Œï¼Œçªç„¶å‡ºç°äº†ä½ ã€‚</div>

<script>
    // æ¸¸æˆçŠ¶æ€
    const gameState = {
        currentStep: 1,
        isDrawing: false,
        startPoint: { x: 0, y: 0 },
        lines: [],
        stickManPos: { x: 50, y: 450 },
        heartPos: { x: 700, y: 450 },
        heartSpeed: 0,
        obstacles: []
    };

    // è·å–DOMå…ƒç´ 
    const gameContainer = document.getElementById('game-container');
    const stickMan = document.getElementById('stick-man');
    const heart = document.getElementById('heart');
    const narration = document.getElementById('narration');
    const proposal = document.getElementById('proposal');
    const yesBtn = document.getElementById('yes-btn');

    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
        updatePositions();
        setupEventListeners();
        startStep1();
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
        gameContainer.addEventListener('mousedown', startDrawing);
        gameContainer.addEventListener('mousemove', drawLine);
        gameContainer.addEventListener('mouseup', endDrawing);
        gameContainer.addEventListener('touchstart', handleTouchStart);
        gameContainer.addEventListener('touchmove', handleTouchMove);
        gameContainer.addEventListener('touchend', handleTouchEnd);
        yesBtn.addEventListener('click', showFireworks);
    }

    // è§¦æ‘¸äº‹ä»¶å¤„ç†
    function handleTouchStart(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = gameContainer.getBoundingClientRect();
        gameState.startPoint = {
            x: touch.clientX - rect.left,
            y: touch.clientY - rect.top
        };
        gameState.isDrawing = true;
    }

    function handleTouchMove(e) {
        if (!gameState.isDrawing) return;
        e.preventDefault();
        const touch = e.touches[0];
        const rect = gameContainer.getBoundingClientRect();
        drawLine({
            clientX: touch.clientX,
            clientY: touch.clientY,
            target: gameContainer
        });
    }

    function handleTouchEnd() {
        gameState.isDrawing = false;
    }

    // ç»˜å›¾åŠŸèƒ½
    function startDrawing(e) {
        const rect = gameContainer.getBoundingClientRect();
        gameState.startPoint = {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
        gameState.isDrawing = true;
    }

    function drawLine(e) {
        if (!gameState.isDrawing) return;

        const rect = gameContainer.getBoundingClientRect();
        const endPoint = {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };

        // åˆ›å»ºçº¿æ¡å…ƒç´ 
        const line = document.createElement('div');
        line.className = 'line';

        // è®¡ç®—çº¿æ¡é•¿åº¦å’Œè§’åº¦
        const length = Math.sqrt(
            Math.pow(endPoint.x - gameState.startPoint.x, 2) +
            Math.pow(endPoint.y - gameState.startPoint.y, 2)
        );

        const angle = Math.atan2(
            endPoint.y - gameState.startPoint.y,
            endPoint.x - gameState.startPoint.x
        ) * 180 / Math.PI;

        // è®¾ç½®çº¿æ¡æ ·å¼
        line.style.width = `${length}px`;
        line.style.height = '3px';
        line.style.left = `${gameState.startPoint.x}px`;
        line.style.top = `${gameState.startPoint.y}px`;
        line.style.transform = `rotate(${angle}deg)`;

        // æ·»åŠ åˆ°æ¸¸æˆå®¹å™¨
        gameContainer.appendChild(line);
        gameState.lines.push(line);

        // æ›´æ–°èµ·ç‚¹
        gameState.startPoint = endPoint;

        // æ£€æŸ¥æ­¥éª¤å®Œæˆæ¡ä»¶
        checkStepCompletion();
    }

    function endDrawing() {
        gameState.isDrawing = false;
    }

    // æ›´æ–°ä½ç½®
    function updatePositions() {
        stickMan.style.left = `${gameState.stickManPos.x}px`;
        stickMan.style.top = `${gameState.stickManPos.y}px`;
        heart.style.left = `${gameState.heartPos.x}px`;
        heart.style.top = `${gameState.heartPos.y}px`;
    }

    // æ¸¸æˆæ­¥éª¤
    function startStep1() {
        narration.textContent = "é‚£å¤©ï¼Œæˆ‘ç©ºç™½çš„ä¸–ç•Œé‡Œï¼Œçªç„¶å‡ºç°äº†ä½ ã€‚";
        gameState.stickManPos = { x: 50, y: 450 };
        gameState.heartPos = { x: 700, y: 450 };
        updatePositions();
    }

    function startStep2() {
        narration.textContent = "æˆ‘æƒ³é è¿‘ä½ ï¼Œå“ªæ€•ä¸€è·¯è·Œè·Œæ’æ’ã€‚";
        gameState.heartSpeed = 2;
        createObstacles();
        animateStep2();
    }

    function startStep3() {
        narration.textContent = "ä½ æ˜¯æˆ‘æ„¿æ„è·¨è¶Šæ‰€æœ‰è·ç¦»çš„ç†ç”±ã€‚";
        gameState.heartSpeed = 0;
        gameState.heartPos = { x: 700, y: 250 };
        gameState.stickManPos = { x: 50, y: 450 };

        // åˆ›å»ºæ‚¬å´–
        const cliff = document.createElement('div');
        cliff.className = 'obstacle';
        cliff.style.width = '650px';
        cliff.style.height = '20px';
        cliff.style.left = '50px';
        cliff.style.top = '470px';
        gameContainer.appendChild(cliff);
        gameState.obstacles.push(cliff);

        updatePositions();
    }

    function startStep4() {
        narration.textContent = "ç°åœ¨ï¼Œæˆ‘æƒ³æŠŠè¿™æ¡è·¯çš„ç»ˆç‚¹ï¼Œå˜æˆæˆ‘ä»¬çš„èµ·ç‚¹ã€‚";
        proposal.style.display = 'block';
    }

    // åˆ›å»ºéšœç¢ç‰©
    function createObstacles() {
        // æ¸…é™¤æ—§éšœç¢ç‰©
        gameState.obstacles.forEach(obs => obs.remove());
        gameState.obstacles = [];

        // å‘
        const pit = document.createElement('div');
        pit.className = 'obstacle';
        pit.style.width = '100px';
        pit.style.height = '50px';
        pit.style.left = '300px';
        pit.style.top = '470px';
        pit.style.backgroundColor = '#f9f9f9';
        pit.style.borderTop = '2px dashed #333';
        gameContainer.appendChild(pit);
        gameState.obstacles.push(pit);

        // äº‘
        for (let i = 0; i < 3; i++) {
            const cloud = document.createElement('div');
            cloud.className = 'cloud';
            const size = 40 + Math.random() * 40;
            cloud.style.width = `${size}px`;
            cloud.style.height = `${size}px`;
            cloud.style.left = `${200 + i * 200}px`;
            cloud.style.top = `${100 + Math.random() * 100}px`;
            gameContainer.appendChild(cloud);
            gameState.obstacles.push(cloud);
        }
    }

    // ç¬¬äºŒæ­¥åŠ¨ç”»
    function animateStep2() {
        if (gameState.currentStep !== 2) return;

        // ç§»åŠ¨çˆ±å¿ƒ
        gameState.heartPos.x -= gameState.heartSpeed;

        // æ£€æŸ¥æ˜¯å¦ç¢°åˆ°éšœç¢ç‰©
        const stickManRect = stickMan.getBoundingClientRect();
        const containerRect = gameContainer.getBoundingClientRect();

        // æ£€æŸ¥æ˜¯å¦æ‰å…¥å‘ä¸­
        if (stickManRect.bottom > containerRect.bottom - 30) {
            // é‡ç½®ä½ç½®
            gameState.stickManPos = { x: 50, y: 450 };
        }

        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾çˆ±å¿ƒ
        const heartRect = heart.getBoundingClientRect();
        if (
            stickManRect.right > heartRect.left &&
            stickManRect.left < heartRect.right &&
            stickManRect.bottom > heartRect.top &&
            stickManRect.top < heartRect.bottom
        ) {
            gameState.currentStep = 3;
            startStep3();
            return;
        }

        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•
        if (gameState.heartPos.x < -50) {
            gameState.heartPos.x = 800;
            gameState.heartPos.y = 300 + Math.random() * 200;
        }

        updatePositions();
        requestAnimationFrame(animateStep2);
    }

    // æ£€æŸ¥æ­¥éª¤å®Œæˆæ¡ä»¶
    function checkStepCompletion() {
        const stickManRect = stickMan.getBoundingClientRect();
        const heartRect = heart.getBoundingClientRect();

        switch (gameState.currentStep) {
            case 1:
                // æ£€æŸ¥å°äººæ˜¯å¦æ¥è§¦åˆ°çˆ±å¿ƒ
                if (
                    stickManRect.right > heartRect.left &&
                    stickManRect.left < heartRect.right &&
                    stickManRect.bottom > heartRect.top &&
                    stickManRect.top < heartRect.bottom
                ) {
                    gameState.currentStep = 2;
                    startStep2();
                }
                break;

            case 3:
                // æ£€æŸ¥æ˜¯å¦ç”»çº¿è¿æ¥äº†æ‚¬å´–
                const bridge = gameState.lines.some(line => {
                    const lineRect = line.getBoundingClientRect();
                    return lineRect.top < 400 && lineRect.bottom > 400 &&
                        lineRect.left < 700 && lineRect.right > 100;
                });

                if (bridge) {
                    // ç§»åŠ¨å°äººåˆ°çˆ±å¿ƒä½ç½®
                    const moveInterval = setInterval(() => {
                        gameState.stickManPos.x += 5;
                        if (gameState.stickManPos.x >= 700) {
                            clearInterval(moveInterval);
                            gameState.currentStep = 4;
                            startStep4();
                        }
                        updatePositions();
                    }, 50);
                }
                break;
        }
    }

    // çƒŸèŠ±æ•ˆæœ
    function showFireworks() {
        proposal.style.display = 'none';
        narration.textContent = "æ­å–œä½ ï¼å¥¹ç­”åº”äº†ä½ çš„æ±‚å©šï¼";

        // åˆ›å»ºçƒŸèŠ±
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.left = `${100 + Math.random() * 600}px`;
                firework.style.top = `${100 + Math.random() * 300}px`;
                firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;

                // è®¾ç½®éšæœºåŠ¨ç”»ç»ˆç‚¹
                const angle = Math.random() * Math.PI * 2;
                const distance = 50 + Math.random() * 100;
                firework.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                firework.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);

                gameContainer.appendChild(firework);

                // ç§»é™¤çƒŸèŠ±å…ƒç´ 
                setTimeout(() => {
                    firework.remove();
                }, 1000);
            }, i * 100);
        }
    }

    // å°äººè·Ÿéšé¼ æ ‡/è§¦æ‘¸ç§»åŠ¨
    gameContainer.addEventListener('mousemove', (e) => {
        if (gameState.currentStep !== 2) return;

        const rect = gameContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // é™åˆ¶ç§»åŠ¨èŒƒå›´
        gameState.stickManPos.x = Math.max(0, Math.min(x, rect.width - 30));
        gameState.stickManPos.y = Math.max(0, Math.min(y, rect.height - 50));

        updatePositions();
    });

    // åˆå§‹åŒ–æ¸¸æˆ
    initGame();
</script>
</body>
</html>