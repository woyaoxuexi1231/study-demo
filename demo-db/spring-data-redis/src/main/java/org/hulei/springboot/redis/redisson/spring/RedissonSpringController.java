package org.hulei.springboot.redis.redisson.spring;

import lombok.extern.slf4j.Slf4j;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

/**
 * @author hulei
 * @since 2025/1/8 14:29
 */

@Slf4j
@RequestMapping("/redisson")
@RestController
public class RedissonSpringController {

    /*
    Redisson æ˜¯ä¸€ä¸ª Java å®¢æˆ·ç«¯åº“ï¼ˆå®˜æ–¹æ¨èï¼‰
    å®ƒåœ¨ Redis åŸºç¡€ä¹‹ä¸Šå°è£…äº†ï¼š
        - åˆ†å¸ƒå¼é”ï¼ˆå¯é‡å…¥é”ã€è¯»å†™é”ã€å…¬å¹³é”ã€è”é”ã€çº¢é”ï¼‰
        - åˆ†å¸ƒå¼é›†åˆï¼ˆMapã€Setã€Listï¼‰
        - ç¼“å­˜å¯¹è±¡ï¼ˆå¸¦è‡ªåŠ¨è¿‡æœŸï¼‰
        - é™æµå™¨ã€ä¿¡å·é‡ã€å‘å¸ƒè®¢é˜…ç­‰
    ä¹Ÿå°±æ˜¯è¯´ï¼ŒRedisson ç›¸å½“äºç»™ Java æä¾›äº†ä¸€ä¸ªæ›´åƒ Java æœ¬åœ°å¯¹è±¡çš„â€œåˆ†å¸ƒå¼å·¥å…·åŒ…â€ï¼Œè€Œä¸æ˜¯è‡ªå·±å»å†™åŸç”Ÿ SET NX PXã€‚

    Redisson ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ
        - éœ€è¦åˆ†å¸ƒå¼é”ï¼ˆç§’æ€ã€åº“å­˜æ‰£å‡ã€å¹‚ç­‰æ“ä½œï¼‰
        - éœ€è¦åˆ†å¸ƒå¼åŒæ­¥å·¥å…·ï¼ˆä¿¡å·é‡ã€CountDownLatchï¼‰
        - éœ€è¦åœ¨é›†ç¾¤ä¸­ä¸€è‡´æ€§æ“ä½œï¼ˆRedLockï¼‰
        - æƒ³ç”¨ Redis æ¥åšæœ¬åœ°å¯¹è±¡ç¼“å­˜æˆ– Map/Queue/Set
     */

    @Autowired
    RedissonClient redisson;

    @Autowired
    ThreadPoolExecutor commonPool;

    @RequestMapping("/lock")
    public void test() {
        /*
        ä½¿ç”¨ SETNX å®ç°åˆ†å¸ƒå¼é”çš„å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ
        ğŸš¨1. é”æœªè®¾ç½®è¿‡æœŸæ—¶é—´å¯¼è‡´çš„æ­»é” å¦‚æœçº¿ç¨‹ A è·å–é”åï¼Œå› å¼‚å¸¸æˆ–ç½‘ç»œé—®é¢˜æœªä¸»åŠ¨é‡Šæ”¾é”ï¼Œé”ä¼šæ°¸ä¹…å­˜åœ¨ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è·å–ã€‚
        ğŸš¨2. é”è¿‡æœŸæ—¶é—´ä¸åˆç†å¯¼è‡´çš„å¹¶å‘é—®é¢˜ è‹¥ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”çš„è¿‡æœŸæ—¶é—´ï¼Œé”ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½è·å–é”å¹¶æ“ä½œå…±äº«èµ„æºï¼Œå¯¼è‡´å¹¶å‘å†²çªã€‚
        ğŸš¨3. åŸå­æ€§æ“ä½œç¼ºå¤± SETNX å’Œ EXPIRE åˆ†ä¸¤æ­¥æ‰§è¡Œï¼Œè‹¥æœåŠ¡å™¨å®•æœºï¼Œå¯èƒ½å¯¼è‡´é”æ— è¿‡æœŸæ—¶é—´ã€‚
        ğŸš¨4. è¯¯åˆ é” çº¿ç¨‹ A åˆ é™¤é”æ—¶ï¼Œå¯èƒ½è¯¯åˆ çº¿ç¨‹ B çš„é”ï¼ˆå¦‚é”è¿‡æœŸåè¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œä½† A ä»æ‰§è¡Œåˆ é™¤ï¼‰ã€‚
        ğŸš¨5. ä¸»ä»åŒæ­¥å¯¼è‡´çš„é”ä¸¢å¤± Redis ä¸»ä»å¤åˆ¶å¼‚æ­¥ï¼Œè‹¥ä¸»åº“å®•æœºï¼Œä»åº“æœªåŒæ­¥é”æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´é”ä¸¢å¤±ã€‚

        Redissonå¦‚ä½•è§£å†³çš„å‘¢ï¼Ÿ
        ğŸ’¡Redisson æ‰€æœ‰é”æ“ä½œï¼ˆåŠ é”ã€é‡Šæ”¾é”ã€ç»­æœŸï¼‰å‡é€šè¿‡ Lua è„šæœ¬åœ¨ Redis æœåŠ¡ç«¯åŸå­æ‰§è¡Œï¼Œé¿å…å¤šæ¡å‘½ä»¤çš„ç«æ€æ¡ä»¶ã€‚
        ğŸ’¡Redisson å†…ç½®â€œçœ‹é—¨ç‹—â€ï¼ˆWatchdogï¼‰æœºåˆ¶ï¼Œé»˜è®¤å¼€å¯ï¼ˆå¯é€šè¿‡é…ç½®å…³é—­ï¼‰ã€‚è§£å†³äº†æ‰‹åŠ¨è®¾ç½® TTL ä¸åˆç†çš„é—®é¢˜ï¼Œæ— éœ€å¼€å‘è€…å¹²é¢„é”çš„ç»­æœŸã€‚

        redissonå®ç°åˆ†å¸ƒå¼é”çš„åŸç†:
        1. ä¸»çº¿ç¨‹å°è¯•é€šè¿‡luaè„šæœ¬åˆ›å»ºmapç±»å‹çš„æ•°æ®ç»“æ„,keyæ˜¯é”çš„åç§°,å†…å®¹æ˜¯é”çš„æŒæœ‰è€…å’Œé‡å…¥çš„æ¬¡æ•°
            - è·å¾—é”çš„çº¿ç¨‹å°†æ­£å¸¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            - æ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹å°†é€šè¿‡redisçš„subscribeè®¢é˜…ä¸€ä¸ªé¢‘é“,é¢‘é“çš„åç§°æ˜¯ redisson_lock__channel:{lockName}, è¿™æ˜¯ä¸ºäº†åœ¨ unlock çš„ç¬¬ä¸€æ—¶é—´å°±å¯ä»¥è¿›è¡ŒæŠ¢é” è€Œä¸å¿…å†ç­‰å¾… ttl äº†
            - æ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹ä¼šä¸€ç›´è½®è¯¢çš„å»æ£€æŸ¥é”è¿™ä¸ªé”®çš„å‰©ä½™æ—¶é—´,ç„¶åç­‰å¾…åˆ°è¶³å¤Ÿæ—¶é—´åå°è¯•å»è·å–é”
        2. å­çº¿ç¨‹é€šè¿‡ä¸€ä¸ªMapä¿å­˜å½“å‰çº¿ç¨‹çš„ä¿¡æ¯,ç„¶åå­çº¿ç¨‹é»˜è®¤æ¯10ç§’è¿›è¡Œç»­çº¦
        3. ä¸»çº¿ç¨‹æ­£å¸¸è§£é”æ—¶ä¼šåˆ é™¤å­çº¿ç¨‹Mapå†…ä¿å­˜çš„çº¿ç¨‹ä¿¡æ¯,ä»¥åŠå‘é€ä¸€æ¡è§£é”çš„æ¶ˆæ¯åˆ°é¢‘é“å†…

        watchdogå¦‚ä½•æ„ŸçŸ¥åˆ°ä¸»çº¿ç¨‹å·²ç»æŒ‚äº†å‘¢ï¼Ÿ
          â‘  finallyåœ¨ä¸€å®šæ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œunlockä¼šåˆ é™¤ EXPIRATION_RENEWAL_MAP ä¸­ä¿å­˜çš„çº¿ç¨‹idä¿¡æ¯ï¼Œè¿™æ ·watchä¸‹æ¬¡ç»­çº¦çš„æ—¶å€™å°±å¯ä»¥çŸ¥é“äº†
          â‘¡ å¦‚æœè¯´jvmæŒ‚äº†ï¼Œé‚£ä¹ˆwatchdogçº¿ç¨‹è‚¯å®šä¹Ÿæ²¡äº†ï¼Œè¿™ç§æƒ…å†µä¸‹åªèƒ½ç­‰ttlç»“æŸäº†
         */

        commonPool.execute(() -> {
            RLock lock = redisson.getLock("myLock");
            try {
                // å°è¯•è·å–é” waiting - ç­‰å¾…è·å–é”çš„æ—¶é—´ leaseTime - æŒæœ‰é”çš„æ—¶é—´ unit - æ—¶é—´å•ä½
                if (lock.tryLock(1, -1, TimeUnit.SECONDS)) {
                    log.info("å·²ç»é€šè¿‡redissonè·å¾—é”!");
                    Thread.sleep(50 * 1000); // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ—¶é—´
                } else {
                    log.info("å½“å‰å·²æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œè·³è¿‡");
                }
            } catch (Exception e) {
                log.error(e.getMessage(), e);
            } finally {
                if (lock.isLocked() && lock.isHeldByCurrentThread()) {
                    lock.unlock();
                    log.info("å·²ç»æˆåŠŸé‡Šæ”¾é”");
                }
            }
        });
    }
}
