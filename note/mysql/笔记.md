# 关于 CHARSET 和 COLLATE

[再见乱码：5分钟读懂MySQL字符集设置 - 程序猿小卡 - 博客园](https://www.cnblogs.com/chyingp/p/mysql-character-set-collation.html)

[MYSQL中的COLLATE是什么？ - 腾讯云开发者 - 博客园](https://www.cnblogs.com/qcloud1001/p/10033364.html)



UTF-8（UTF-8MB3）与UTF-8MB4的基本区别

- **UTF-8（也称为UTF-8MB3）**：这是MySQL中的一种字符集，它支持最长为三个字节的字符。这意味着它可以存储基本多语言平面（BMP）中的字符，但不支持四字节的Unicode字符，如某些罕见的汉字、表情符号或新加入Unicode的字符。
- **UTF-8MB4**：这是UTF-8的超集，它支持最长为四个字节的字符。这使得它能够存储所有Unicode字符，包括BMP之外的字符和表情符号等。从MySQL 5.5.3版本开始支持UTF-8MB4。



# MySQL的默认库



MySQL默认的四个系统库及其作用如下：

---

### **1. `information_schema`**
- **作用**：存储数据库的**元数据**信息，提供对数据库结构的只读访问。
- **关键内容**：
  - 数据库、表、列、索引、权限等元数据（如`TABLES`、`COLUMNS`、`SCHEMATA`表）。
  - 视图、存储过程、触发器等对象信息。
- **特点**：
  - 数据通过**视图**动态生成，不直接存储数据。
  - 用户不可修改，用于查询数据库结构（如`SHOW`命令的底层实现）。

---

### **2. `mysql`**
- **作用**：存储**用户账户、权限、系统配置**及核心数据。
- **关键内容**：
  - 用户与权限表（如`user`、`db`、`tables_priv`）。
  - 存储过程、事件、触发器定义。
  - 时区配置、日志配置（如`time_zone`、`general_log`）。
- **特点**：
  - 直接修改可能导致系统不稳定，建议使用`GRANT`、`ALTER USER`等SQL语句管理。
  - 包含关键系统数据（如`root`用户密码）。

---

### **3. `performance_schema`**
- **作用**：收集MySQL服务器的**运行时性能数据**，用于监控与分析。
- **关键内容**：
  - 资源使用情况（CPU、内存、I/O）。
  - 查询执行细节、锁竞争、连接信息。
  - 事件监控（如`events_statements_summary_by_digest`）。
- **特点**：
  - 数据基于配置项动态采集，默认部分功能开启。
  - 用于深度性能调优，表结构复杂，需结合文档使用。

---

### **4. `sys`**
- **作用**：提供**简化视图与工具**，辅助性能分析与诊断。
- **关键内容**：
  - 基于`information_schema`和`performance_schema`的预定义视图（如`schema_table_statistics`）。
  - 常用性能指标汇总（如高负载查询、索引使用情况）。
- **特点**：
  - 专为DBA设计，简化复杂性能查询（如`sys.session`视图）。
  - 无独立数据，依赖底层系统库，MySQL 5.7+版本默认集成。

---

### **注意事项**
- **版本差异**：`sys`库在MySQL 5.7及以上版本默认存在，旧版本需手动安装。
- **安全操作**：避免直接修改系统库表（如`mysql.user`），优先使用专用SQL语句。
- **性能开销**：`performance_schema`可能占用资源，可按需配置监控项。

通过这四个库，MySQL实现了元数据管理、权限控制、性能监控与优化支持的核心功能。



# 关于锁

mysql官方文档对锁的详细解释。

[MySQL :: MySQL 8.4 Reference Manual :: 17.7.1 InnoDB Locking](https://dev.mysql.com/doc/refman/8.4/en/innodb-locking.html)



一些文档

[MySQL锁、加锁机制（超详细）—— 锁分类、全局锁、共享锁、排他锁；表锁、元数据锁、意向锁；行锁、间隙锁、临键锁；乐观锁、悲观锁-腾讯云开发者社区-腾讯云](https://cloud.tencent.com/developer/article/2431018)



# 事务

## mysql事务简要介绍

MySQL是一种流行的关系型数据库管理系统（RDBMS），它支持事务的概念，可以确保数据库操作的原子性、一致性、隔离性和持久性（ACID属性）。

以下是关于MySQL事务的简单介绍：

1. **事务的概念**：事务是一组数据库操作，这些操作要么全部执行成功，要么全部失败，没有中间状态。事务是数据库管理系统中实现数据一致性和完整性的重要机制。

2. **事务的ACID特性**：
   - **原子性（Atomicity）**：事务中的所有操作要么全部执行成功，要么全部失败，没有部分执行的情况。如果一个操作失败，则整个事务会被回滚到事务开始前的状态。
   - **一致性（Consistency）**：事务执行后，数据库从一个一致的状态转换到另一个一致的状态。即使在事务执行过程中发生错误，数据库也不会处于矛盾或不一致的状态。
   - **隔离性（Isolation）**：事务的执行不受其他事务的影响，即使多个事务同时执行，它们之间也相互独立。每个事务都应该感知到数据库在其执行期间保持一致性的状态。
   - **持久性（Durability）**：一旦事务提交，其结果应该永久保存在数据库中，即使发生系统崩溃或故障，数据也不会丢失。

3. **事务的控制语句**：MySQL提供了以下几个常用的事务控制语句：
   - `START TRANSACTION`、`begin`：开始一个新的事务。
   - `COMMIT`：提交当前事务，将所有的操作持久化到数据库中。
   - `ROLLBACK`：回滚当前事务，撤销所有的未提交操作，恢复到事务开始前的状态。

4. **事务隔离级别**：MySQL支持不同的事务隔离级别，包括读未提交（Read Uncommitted）、读已提交（Read Committed）、可重复读（Repeatable Read）和串行化（Serializable）。这些隔离级别决定了事务之间相互影响的程度。



## log

Undolog、Redolog和Binlog在MySQL中扮演着不同的角色，它们的出现分别解决了数据库的不同问题。

1. **Undo日志（Undolog）**：
   - Undo日志记录了事务执行前的数据状态，主要用于事务的回滚和MVCC（多版本并发控制）机制的实现。
   - 当事务执行更新操作时，Undo日志记录了更新前的数据状态，以便在事务回滚或者数据库崩溃恢复时将数据恢复到更新前的状态。

2. **Redo日志（Redolog）**：
   - Redo日志记录了事务执行后的数据修改操作，主要用于数据库的崩溃恢复和数据持久性的保证。
   - 当事务执行更新操作时，Redo日志记录了更新操作的具体细节，包括修改的页号、偏移量以及修改后的数据值，以便在数据库崩溃后重新应用修改操作。

3. **Binlog（Binary Log）**：
   - Binlog记录了数据库中所有的数据修改操作，主要用于数据备份、数据恢复、数据库复制和数据审计等场景。
   - Binlog记录了每个数据修改操作的逻辑细节，包括事务的提交、回滚以及DDL语句的执行，通过分析Binlog文件可以实现对数据库的数据备份、恢复、复制和审计。

总的来说，Undolog主要解决了事务的原子性和隔离性问题，Redolog主要解决了数据库的持久性问题，而Binlog主要用于数据备份、恢复、复制和审计等用途。这三种日志文件各自发挥着重要的作用，共同保证了数据库的可靠性、一致性和安全性。

### undo_log

MySQL的undo日志（Undo Log），记录事务修改前的数据，用于事务失败时的回滚。

主要用于实现事务的原子性和多版本并发控制（MVCC）

1. **作用**：
   - 记录事务执行过程中对数据的修改操作。
   - 用于事务的回滚操作，当事务发生错误或者被撤销时，MySQL可以利用Undo日志将数据恢复到事务开始前的状态。
   - 用于实现MVCC（多版本并发控制）机制，当事务需要读取历史版本的数据时，MySQL可以利用Undo日志提供相应的数据版本。

2. **记录内容**：
   - 对于INSERT：记录主键信息，回滚时执行DELETE
   - 对于DELETE：记录完整行数据，回滚时执行INSERT
   - 对于UPDATE：记录被修改前的数据，回滚时恢复原值

3. **Undo日志的存储方式**：
   - Undo日志通常存储在磁盘上的Undo表空间中，它是一个特殊的系统表空间。
   - MySQL通过共享表空间的方式管理Undo日志，多个数据库共享同一个Undo表空间。

4. **Undo日志的生命周期**：
   - Undo日志的生命周期与事务的生命周期密切相关。当事务开始时，MySQL会为该事务分配一块Undo日志区域，用于记录该事务执行过程中的修改操作。
   - 当事务提交或者回滚时，相关的Undo日志区域会被释放，以便重用。

5. **性能优化**：
   - MySQL的InnoDB存储引擎支持Undo日志的优化技术，包括Undo表空间的自动扩展、Undo日志的延迟写入、Undo日志的压缩等，以提高Undo日志的性能和效率。

### redo_log

redo日志（Redo Log，重做日志），保证原子性和持久性。

1. **作用**：
   - 记录事务对数据库进行的所有修改操作，包括插入、更新和删除等操作。
   - 用于事务的持久化，确保在数据库发生故障或崩溃时可以将事务的修改操作重新应用到数据库中，从而保证数据的一致性和完整性。

2. **记录内容**：
   - Redo日志记录了事务对数据库进行的所有修改操作，但与Undo日志不同，它不记录修改前的数据内容，而是记录了修改操作的具体细节，如修改的页号、偏移量以及修改后的数据值。
   - Redo日志记录的信息是物理日志，它记录了数据页的物理变化。

3. **Redo日志的存储方式**：
   - Redo日志通常存储在磁盘上的Redo日志文件中，这些文件是MySQL的数据目录中的特殊文件。
   - MySQL会定期将Redo日志缓冲区中的日志写入Redo日志文件，以保证数据的持久化。

4. **Redo日志的生命周期**：
   - Redo日志的生命周期与事务的生命周期密切相关。当事务提交时，相关的Redo日志会被写入Redo日志文件，以确保事务的持久化。
   - Redo日志的写入操作是顺序写入，因此效率比较高。同时，Redo日志是循环使用的，当Redo日志文件达到一定大小或者发生满足条件的检查点时，会被重用。

5. **性能优化**：
   - MySQL的InnoDB存储引擎支持Redo日志的优化技术，包括Redo日志的组提交、Redo日志的延迟写入、Redo日志的缓冲等，以提高Redo日志的性能和效率。

### undo_log和redo_log结合

**Undolog和Redolog详细操作过程：**

1. **事务开始**：事务T1开始。

2. **生成Undo日志**：数据库为事务T1分配Undo日志区域，并在Undo日志中记录当前余额的修改前的值（1000元）。

3. **生成Redo日志**：数据库为事务T1分配Redo日志区域，并在Redo日志中记录当前余额的修改操作的具体细节，包括修改的页号、偏移量以及修改后的数据值。

4. **执行更新操作**：事务T1执行一条更新语句，将某个客户的余额从1000元增加到2000元。

5. **生成Undo日志**：在执行更新操作时，数据库再次在Undo日志中记录修改前的数据内容（1000元），以备将来回滚。

6. **生成Redo日志**：在执行更新操作时，数据库在Redo日志中记录将余额增加到2000元的具体修改操作的细节。

7. **提交事务**：事务T1提交。

8. **将Redo日志写入磁盘**：数据库将Redo日志中的数据刷新到数据库的磁盘文件中，确保数据的持久性。

**如何判断事务是否已经提交：**

在MySQL中，可以通过检查Undo日志和Redo日志的状态来判断事务是否已经提交：

- 如果Undo日志中记录了事务T1的修改前的数据内容，但是Redo日志中没有相应的修改操作，则表示事务T1尚未提交。
- 如果Undo日志和Redo日志中都记录了事务T1的修改操作，且Redo日志已经写入磁盘，则表示事务T1已经提交。

**数据库宕机后的操作：**

在数据库宕机后，根据Undo日志和Redo日志的状态，可以进行以下操作：

- 如果Undo日志中记录了事务T1的修改前的数据内容，但是Redo日志中没有相应的修改操作，则需要回滚未提交的事务T1。
- 如果Undo日志和Redo日志中都记录了事务T1的修改操作，且Redo日志已经写入磁盘，则不需要进行回滚，因为事务T1已经提交。

### binlog

MySQL的binlog（Binary Log）是MySQL数据库引擎提供的一种日志文件，用于记录数据库中所有的数据修改操作，包括插入、更新和删除等操作。与Redo日志类似，binlog也是一种用于实现事务的持久性和恢复性的重要组件。

以下是关于MySQL的binlog的一些重要信息：

1. **作用**：
   - 记录数据库中的所有数据修改操作，包括事务的提交、回滚以及DDL（Data Definition Language）语句的执行等。
   - 用于数据备份、数据恢复、数据库复制和数据审计等用途。

2. **记录内容**：
   - Binlog文件以二进制格式记录了每个数据修改操作的具体细节，包括修改操作的类型、受影响的数据行、修改前的数据内容以及修改后的数据内容等。
   - Binlog文件记录的信息是逻辑日志，它记录了数据修改操作的逻辑细节。

3. **存储位置**：
   - Binlog文件默认存储在MySQL的数据目录中，文件名通常以"mysql-bin"开头，后面跟着一串数字表示文件序号。例如，mysql-bin.000001、mysql-bin.000002等。
   - 可以通过配置文件或者动态参数来指定Binlog文件的存储路径和文件名格式。

4. **使用场景**：
   - 数据备份与恢复：通过恢复Binlog文件中的数据修改操作，可以实现对数据库的定点恢复或者将数据库恢复到某个特定时间点的状态。
   - 数据库复制与同步：通过将Binlog文件复制到其他MySQL实例上，可以实现数据库的主从复制、主从同步和数据分发等功能。
   - 数据审计与性能分析：通过分析Binlog文件中的数据修改操作，可以进行数据审计和性能分析，了解数据库的使用情况和性能瓶颈。

综上所述，MySQL的binlog是一种重要的日志文件，用于记录数据库中的所有数据修改操作，实现事务的持久性、恢复性和数据库的复制与同步等功能。通过合理管理和利用binlog，可以提高数据库的可靠性、可用性和安全性。