```bash
curl -i "http://127.0.0.1:9180/apisix/admin/routes" \
-X POST \
-H "X-API-Key: edd1c98034335f136f87ad84b625c8f1" \
-d '{
  "name": "getting-started-ip2",
  "uri": "/ip",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  },
  "plugins": {
    "share-limit": {}
  }
}'

# 调用 /ip 接口
curl "http://127.0.0.1:9080/ip"
```



一个非常简单lua的插件

```lua
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by User.
--- DateTime: 2024/12/25 9:31
---


-- Define the plugin
local plugin_name = "log_request"
local core = require("apisix.core")

-- Plugin schema
default_schema = {
    type = "object",
    properties = {},
}

local _M = {
    version = 0.1,
    priority = 10,  -- Adjust priority as needed, higher values run earlier
    name = plugin_name,
    schema = default_schema
}

-- Handler for access phase
function _M.access(conf, ctx)
    local request_info = {
        method = core.request.get_method(),
        uri = core.request.get_uri(),
        headers = core.request.headers(ctx),
        body = core.request.get_body(),
    }

    -- Log the request details
    core.log.info("Request Details: ", core.json.encode(request_info))
end

-- Register the plugin
return _M
```



# 配置lua插件到apisix

https://apisix.apache.org/docs/dashboard/FAQ/#4-after-modifying-the-plugin-schema-or-creating-a-custom-plugin-in-apache-apisix-why-cant-i-find-it-on-the-dashboard

apisix的默认配置文件中有关于插件的配置  

/usr/local/apisix/conf/config-default.yaml

```yaml
# 在 plugins 参数最后添加对应的插件名
plugins:  
	...
	- log-request
```

或者在 config.yaml 配置文件中添加，但是需要把plugins在config-default.yaml中的其他插件也一起拿过来，否则apisix自带的插件可能会不生效。配置和上面一致。



配置好后为了能在 dashborad 中展示出来，需要重新生成 dashboard 的 schema.json

```bash
curl 127.0.0.1:9090/v1/schema > schema.json
```

生成好之后放在 dashboard 安装路径下的config文件夹中 /usr/local/apisix/dashboard/conf (之前的文件可以备份一份)

配置好之后还需要在 dashboard 的conf.yaml配置文件中配置该插件，和apisix配置插件一致。然后重启 apisix-dashboard，就可以看到新增的自定义lua插件。



# 开发lua插件

需要用到nginx共享内存，第一步需要添加nginx.conf配置共享内存。

```nginx
http {
    ...
	lua_shared_dict plugin-custom-limit 10m;
    ...
}
```

但是apisix每次重启会覆盖配置nginx.conf配置文件，所以不能在这里配置，还是需要到apisix的config.yaml中进行配置。

```yaml
# 新增一个这个配置
nginx_config:
  http_configuration_snippet: |
    lua_shared_dict plugin-custom-limit 10m;
    # 用户保存重置时间信息
    lua_shared_dict plugin-custom-limit-reset-header 10m;
```

为了处理json，需要下载json的依赖库。

```bash
luarocks install lua-cjson
```

